log:
    level: info
plugins:
    - tag: lazy_cache
      type: cache
      args:
        size: 8000
        lazy_cache_ttl: 86400

    - tag: domain_cn
      type: domain_set
      args:
        files:
          - "/var/etc/bypass/domains_cn.txt"

    - tag: domain_not_cn
      type: domain_set
      args:
        files:
          - "/var/etc/bypass/gfw.list"

    - tag: china_v4
      type: ip_set
      args:
        files:
          - "/var/etc/bypass/china.txt"

    - tag: dns_local
      type: forward
      args:
        concurrent: 2
        upstreams:
          - addr: local_dns

    - tag: dns_remote
      type: forward
      args:
        concurrent: 2
        upstreams:
          - addr: remote_dns

    - tag: local_sequence
      type: sequence
      args:
        - exec: $dns_local

    - tag: remote_sequence_IPv6
      type: sequence
      args:
        - exec: $dns_remote

    - tag: remote_sequence_no_IPv6
      type: sequence
      args:
        - exec: prefer_ipv4
        - exec: $dns_remote
        - matches: 
          - qtype 28 65
          exec: reject 0

    - tag: query_local_domain
      type: sequence
      args:
        - matches: qname $domain_cn
          exec: $local_sequence

    - tag: query_is_no_local_domain
      type: sequence
      args:
        - matches: qname $domain_not_cn
          exec: $query_remote_ip

    - tag: query_local_ip
      type: sequence
      args:
        - exec: $local_sequence
        - matches: "!resp_ip $china_v4"
          exec: drop_resp

    - tag: query_remote_ip
      type: sequence
      args:
        - exec: $IPV6MODE

    - tag: fallback
      type: fallback
      args:
        primary: POLLUTION
        secondary: query_remote_ip
        threshold: 500
        always_standby: true

    - tag: has_resp_sequence
      type: sequence
      args:
        - matches: has_resp
          exec: accept

    - tag: main_sequence
      type: sequence
      args:
          exec: $lazy_cache
        - exec: $query_local_domain
        - exec: jump has_resp_sequence
        - exec: $query_is_no_local_domain
        - exec: jump has_resp_sequence
        - exec: $fallback

    - tag: udp_server
      type: udp_server
      args:
        entry: main_sequence
        listen: ":DNS_PORT"

    - tag: tcp_server
      type: tcp_server
      args:
        entry: main_sequence
        listen: ":DNS_PORT"
