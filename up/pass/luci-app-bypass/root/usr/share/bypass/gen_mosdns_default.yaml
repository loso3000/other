log:
  level: info
plugins:
    - tag: lazy_cache
      type: cache
      args:
        size: 20000
        lazy_cache_ttl: 86400
	
# Num1: CN domain
  - tag: domain_cn
      type: domain_set
      args:
        files:
        - "/var/etc/bypass/domains_cn.txt"
        - "/etc/bypass/white.list"
	
# Num2: no CN domain
  - tag: domain_not_cn
    type: domain_set
    args:
      files:
        - "/var/etc/bypass/gfw.list"
	- "/etc/ssrplus/black.list"
	
# Num3: CN IPv4
  - tag: china_v4
      type: ip_set
      args:
        files:
        - "/var/etc/bypass/china.txt"
	
# Num4: CN IPv4
  - tag: china_v6
    type: ip_set
    args:
      files:
        - "/var/etc/bypass/china_v6.txt"
# Num5
  - tag: domain_apple
      type: domain_set
      args:
        files:
        - "/var/etc/bypass/domain_apple.txt"
# Num6
  - tag: adlist
    type: domain_set
    args:
      files:
        AD_LIST
	
# Num7
    - tag: dns_local
      type: forward
      args:
        concurrent: 2
        upstreams:
        - addr: local_dns
# Num8	
    - tag: dns_remote
      type: forward
      args:
        concurrent: 2
        upstreams:
        - addr: remote_dns

# Num9
    - tag: local_sequence
      type: sequence
      args:
        - exec: $dns_local

# Num10
    - tag: remote_sequence_with_IPv6
      type: sequence
      args:
        - exec: $dns_remote

# Num11
    - tag: remote_sequence_disable_IPv6
      type: sequence
      args:
        - exec: prefer_ipv4
        - exec: $dns_remote
        - matches: 
          - qtype 28 65
          exec: reject 0

# Num12
    - tag: query_is_local_domain
      type: sequence
      args:
        - matches: qname $domain_cn
          exec: $local_sequence
    
# Num13
    - tag: query_is_proxy_domain
      type: sequence
      args:
        - matches: qname $domain_not_cn
        - exec: ipset blacklist,inet,24

    # fallback 用本地服务器 sequence
    # 返回非国内 ip 则 drop_resp
    # Num14
    - tag: query_is_local_ip
      type: sequence
      args:
        - exec: $local_sequence
        - matches: "!resp_ip $china_v4"
          exec: drop_resp

    # Num15
    # fallback 用远程服务器 sequence
    - tag: query_is_remote_ip
      type: sequence
      args:
        - exec: $remote_sequence_disable_IPv6
        - exec: ipset blacklist,inet,24

    # fallback 用远程服务器 sequence
    # query_is_local_ip to query_is_remote_ip
    # Num16
    - tag: fallback
      type: fallback
      args:
        # DNS Leak solution
        primary: query_is_local_ip
        secondary: query_is_remote_ip
        threshold: 600
        always_standby: true

    # 有响应终止返回
    # Num17
    - tag: has_resp_sequence
      type: sequence
      args:
        - matches: has_resp
          exec: accept

    # Num18
    - tag: main_sequence
      type: sequence
      args:
        - exec: $lazy_cache
        - exec: $query_is_local_domain
        - exec: jump has_resp_sequence
        - exec: $query_is_proxy_domain
        - exec: jump has_resp_sequence
        - exec: $fallback

    # Num19
    - tag: udp_server
      type: udp_server
      args:
        entry: main_sequence
      listen: ":listen_port"

    # Num20
    - tag: tcp_server
      type: tcp_server
      args:
        entry: main_sequence
      listen: ":listen_port"
