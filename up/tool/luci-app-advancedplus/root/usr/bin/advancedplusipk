#!/bin/sh

skin="Kucat"

is_x86_64() {
    DISTRIB_ARCH=$(cat /etc/openwrt_release | grep "DISTRIB_ARCH" | cut -d "'" -f 2)
    if [ "$DISTRIB_ARCH" = "x86_64" ]; then
        return 0
    else
        return 1
    fi
}

remove_check_signature_option() {
    local opkg_conf="/etc/opkg.conf"
    sed -i '/option check_signature/d' "$opkg_conf"
}

is_iStoreOS() {
    [ -s "/www/luci-static/istore/index.js" ] && return 0  || return 1
}

is_free() {
     DISTRIB_FREE=$(cat /etc/openwrt_release | grep "Free" | cut -d " " -f 2 | cut -d "-" -f 1)
    if [ "$DISTRIB_FREE" = "Free" ]; then
        return 0
    else
        return 1
    fi
}

istore_install(){
    if is_iStoreOS; then
        echo "已经内置iStore应用商店,无须安装！"
     else
       echo "正在安装iStore应用商店...."
	remove_check_signature_option
        opkg update
        opkg remove git-lfs
        setup_software_source 1
	ISTORE_REPO=https://istore.linkease.com/repo/all/store
	FCURL="curl --fail --show-error"
	curl -V >/dev/null 2>&1 || {
  	  echo "prereq: install curl"
  	  opkg info curl | grep -Fqm1 curl || opkg update
  	  opkg install curl
	}
	IPK=$($FCURL "$ISTORE_REPO/Packages.gz" | zcat | grep -m1 '^Filename: luci-app-store.*\.ipk$' | sed -n -e 's/^Filename: \(.\+\)$/\1/p')
	[ -n "$IPK" ] || exit 1
	$FCURL "$ISTORE_REPO/$IPK" | tar -xzO ./data.tar.gz | tar -xzO ./bin/is-opkg >/tmp/is-opkg
	chmod 755 /tmp/is-opkg
	/tmp/is-opkg update
	# /tmp/is-opkg install taskd
	/tmp/is-opkg opkg install --force-reinstall luci-lib-taskd luci-lib-xterm
	/tmp/is-opkg opkg install --force-reinstall luci-app-store || exit $?
	[ -s "/etc/init.d/tasks" ] || /tmp/is-opkg opkg install --force-reinstall taskd
	[ -s "/usr/lib/lua/luci/cbi.lua" ] || /tmp/is-opkg opkg install luci-compat >/dev/null 2>&1
            uci set system.@system[0].hostname='iStoreOS'
            uci commit system
            /etc/init.d/system reload
            if is_x86_64; then
                extra_info="with iStoreOS Style"
                current_revision=$(grep "DISTRIB_REVISION" /etc/openwrt_release | cut -d "'" -f 2)
                if [[ $current_revision != *"$extra_info"* ]]; then
                    new_revision="${current_revision} ${extra_info}"
                    sed -i "s/DISTRIB_REVISION=.*$/DISTRIB_REVISION='$new_revision'/" /etc/openwrt_release
                fi
            else
                if ! grep -q " like iStoreOS" /tmp/sysinfo/model; then
                    sed -i '1s/$/ like iStoreOS/' /tmp/sysinfo/model
                fi
            fi
        uci set luci.main.mediaurlbase='/luci-static/Kucat'
        uci commit
	rm -rf /tmp/is-opkg
        echo "iStore应用商店安装完成."
    fi
}

drv_install(){
    echo "开始安装Docker安装完成..."
    if is_free; then
            echo "目前此功能仅限VIP版本提供！"
    else
            bash /etc/kmodreg docker
    fi
    echo "Docker安装完成."
}

docker_install(){
    echo "开始安装所有驱动..."
    if is_free; then
        echo "目前此功能仅限VIP版本提供！"
    else
        bash /etc/kmodreg drv 
    fi
    echo "所有驱动完成！"
}

case $1 in
    istore) 
        istore_install ;;  
    drv) 
        drv_install ;;  
    docker) 
        docker_install;;  
    esac